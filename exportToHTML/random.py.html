<html>
<head>
<title>random.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
random.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright 2018 The JAX Authors.</span>
<span class="s0">#</span>
<span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="s0"># you may not use this file except in compliance with the License.</span>
<span class="s0"># You may obtain a copy of the License at</span>
<span class="s0">#</span>
<span class="s0">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="s0">#</span>
<span class="s0"># Unless required by applicable law or agreed to in writing, software</span>
<span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="s0"># See the License for the specific language governing permissions and</span>
<span class="s0"># limitations under the License.</span>

<span class="s2">&quot;&quot;&quot;Utilities for pseudo-random number generation. 
 
The :mod:`jax.random` package provides a number of routines for deterministic 
generation of sequences of pseudorandom numbers. 
 
Basic usage 
----------- 
 
&gt;&gt;&gt; seed = 1701 
&gt;&gt;&gt; num_steps = 100 
&gt;&gt;&gt; key = jax.random.PRNGKey(seed) 
&gt;&gt;&gt; for i in range(num_steps): 
...   key, subkey = jax.random.split(key) 
...   params = compiled_update(subkey, params, next(batches))  # doctest: +SKIP 
 
PRNG Keys 
--------- 
 
Unlike the *stateful* pseudorandom number generators (PRNGs) that users of NumPy and 
SciPy may be accustomed to, JAX random functions all require an explicit PRNG state to 
be passed as a first argument. 
The random state is described by two unsigned 32-bit integers that we call a **key**, 
usually generated by the :py:func:`jax.random.PRNGKey` function:: 
 
    &gt;&gt;&gt; from jax import random 
    &gt;&gt;&gt; key = random.PRNGKey(0) 
    &gt;&gt;&gt; key 
    Array([0, 0], dtype=uint32) 
 
This key can then be used in any of JAX's random number generation routines:: 
 
    &gt;&gt;&gt; random.uniform(key) 
    Array(0.41845703, dtype=float32) 
 
Note that using a key does not modify it, so reusing the same key will lead to the same result:: 
 
    &gt;&gt;&gt; random.uniform(key) 
    Array(0.41845703, dtype=float32) 
 
If you need a new random number, you can use :meth:`jax.random.split` to generate new subkeys:: 
 
    &gt;&gt;&gt; key, subkey = random.split(key) 
    &gt;&gt;&gt; random.uniform(subkey) 
    Array(0.10536897, dtype=float32) 
 
Advanced 
-------- 
 
Design and Context 
================== 
 
**TLDR**: JAX PRNG = `Threefry counter PRNG &lt;http://www.thesalmons.org/john/random123/papers/random123sc11.pdf&gt;`_ 
+ a functional array-oriented `splitting model &lt;https://dl.acm.org/citation.cfm?id=2503784&gt;`_ 
 
See `docs/jep/263-prng.md &lt;https://github.com/google/jax/blob/main/docs/jep/263-prng.md&gt;`_ 
for more details. 
 
To summarize, among other requirements, the JAX PRNG aims to: 
 
1.  ensure reproducibility, 
2.  parallelize well, both in terms of vectorization (generating array values) 
    and multi-replica, multi-core computation. In particular it should not use 
    sequencing constraints between random function calls. 
 
Advanced RNG configuration 
========================== 
 
JAX provides several PRNG implementations (controlled by the 
`jax_default_prng_impl` flag). 
 
-   **default** 
    `A counter-based PRNG built around the Threefry hash function &lt;http://www.thesalmons.org/john/random123/papers/random123sc11.pdf&gt;`_. 
-   *experimental* A PRNG that thinly wraps the XLA Random Bit Generator (RBG) algorithm. See 
    `TF doc &lt;https://www.tensorflow.org/xla/operation_semantics#rngbitgenerator&gt;`_. 
 
    -   &quot;rbg&quot; uses ThreeFry for splitting, and XLA RBG for data generation. 
    -   &quot;unsafe_rbg&quot; exists only for demonstration purposes, using RBG both for 
        splitting (using an untested made up algorithm) and generating. 
 
    The random streams generated by these experimental implementations haven't 
    been subject to any empirical randomness testing (e.g. Big Crush). The 
    random bits generated may change between JAX versions. 
 
The possible reasons not use the default RNG are: 
 
1.  it may be slow to compile (specifically for Google Cloud TPUs) 
2.  it's slower to execute on TPUs 
3.  it doesn't support efficient automatic sharding / partitioning 
 
Here is a short summary: 
 
.. table:: 
   :widths: auto 
 
   =================================   ========  =========  ===  ==========  =====  ============ 
   Property                            Threefry  Threefry*  rbg  unsafe_rbg  rbg**  unsafe_rbg** 
   =================================   ========  =========  ===  ==========  =====  ============ 
   Fastest on TPU                                           ✅   ✅          ✅     ✅ 
   efficiently shardable (w/ pjit)                ✅                         ✅     ✅ 
   identical across shardings           ✅        ✅        ✅   ✅ 
   identical across CPU/GPU/TPU         ✅        ✅ 
   identical across JAX/XLA versions    ✅        ✅ 
   =================================   ========  =========  ===  ==========  =====  ============ 
 
(*): with jax_threefry_partitionable=1 set 
(**): with XLA_FLAGS=--xla_tpu_spmd_rng_bit_generator_unsafe=1 set 
 
The difference between &quot;rbg&quot; and &quot;unsafe_rbg&quot; is that while &quot;rbg&quot; uses a less 
robust/studied hash function for random value generation (but not for 
`jax.random.split` or `jax.random.fold_in`), &quot;unsafe_rbg&quot; additionally uses less 
robust hash functions for `jax.random.split` and `jax.random.fold_in`. Therefore 
less safe in the sense that the quality of random streams it generates from 
different keys is less well understood. 
 
For more about jax_threefry_partitionable, see 
https://jax.readthedocs.io/en/latest/notebooks/Distributed_arrays_and_automatic_parallelization.html#generating-random-numbers 
&quot;&quot;&quot;</span>

<span class="s3">from </span><span class="s1">jax._src.prng </span><span class="s3">import </span><span class="s1">PRNGKeyArray </span><span class="s3">as </span><span class="s1">_PRNGKeyArray</span>
<span class="s0"># TODO(frostig): remove this typechecking workaround. Our move away</span>
<span class="s0"># from PRNGKeyArray as a pytree led to Python typechecker breakages in</span>
<span class="s0"># several downstream annotations (e.g. annotations in jax-dependent</span>
<span class="s0"># libraries that are violated by their callers). It may be that the</span>
<span class="s0"># pytree registration decorator invalidated the checks. This will be</span>
<span class="s0"># easier to handle after we always enable_custom_prng.</span>
<span class="s3">import </span><span class="s1">typing</span>
<span class="s3">if </span><span class="s1">typing.TYPE_CHECKING:</span>
  <span class="s1">PRNGKeyArray = typing.Any</span>
  <span class="s1">KeyArray = typing.Any</span>
<span class="s3">else</span><span class="s1">:</span>
  <span class="s0"># TODO(frostig): replace with KeyArray from jax._src.random once we</span>
  <span class="s0"># always enable_custom_prng</span>
  <span class="s1">PRNGKeyArray = _PRNGKeyArray</span>
  <span class="s1">KeyArray = PRNGKeyArray</span>

<span class="s0"># Note: import &lt;name&gt; as &lt;name&gt; is required for names to be exported.</span>
<span class="s0"># See PEP 484 &amp; https://github.com/google/jax/issues/7570</span>

<span class="s3">from </span><span class="s1">jax._src.random </span><span class="s3">import </span><span class="s1">(</span>
  <span class="s1">PRNGKey </span><span class="s3">as </span><span class="s1">PRNGKey</span><span class="s3">,</span>
  <span class="s1">ball </span><span class="s3">as </span><span class="s1">ball</span><span class="s3">,</span>
  <span class="s1">bernoulli </span><span class="s3">as </span><span class="s1">bernoulli</span><span class="s3">,</span>
  <span class="s1">beta </span><span class="s3">as </span><span class="s1">beta</span><span class="s3">,</span>
  <span class="s1">bits </span><span class="s3">as </span><span class="s1">bits</span><span class="s3">,</span>
  <span class="s1">categorical </span><span class="s3">as </span><span class="s1">categorical</span><span class="s3">,</span>
  <span class="s1">cauchy </span><span class="s3">as </span><span class="s1">cauchy</span><span class="s3">,</span>
  <span class="s1">chisquare </span><span class="s3">as </span><span class="s1">chisquare</span><span class="s3">,</span>
  <span class="s1">choice </span><span class="s3">as </span><span class="s1">choice</span><span class="s3">,</span>
  <span class="s1">default_prng_impl </span><span class="s3">as </span><span class="s1">default_prng_impl</span><span class="s3">,</span>
  <span class="s1">dirichlet </span><span class="s3">as </span><span class="s1">dirichlet</span><span class="s3">,</span>
  <span class="s1">double_sided_maxwell </span><span class="s3">as </span><span class="s1">double_sided_maxwell</span><span class="s3">,</span>
  <span class="s1">exponential </span><span class="s3">as </span><span class="s1">exponential</span><span class="s3">,</span>
  <span class="s1">f </span><span class="s3">as </span><span class="s1">f</span><span class="s3">,</span>
  <span class="s1">fold_in </span><span class="s3">as </span><span class="s1">fold_in</span><span class="s3">,</span>
  <span class="s1">gamma </span><span class="s3">as </span><span class="s1">gamma</span><span class="s3">,</span>
  <span class="s1">generalized_normal </span><span class="s3">as </span><span class="s1">generalized_normal</span><span class="s3">,</span>
  <span class="s1">geometric </span><span class="s3">as </span><span class="s1">geometric</span><span class="s3">,</span>
  <span class="s1">gumbel </span><span class="s3">as </span><span class="s1">gumbel</span><span class="s3">,</span>
  <span class="s1">key </span><span class="s3">as </span><span class="s1">key</span><span class="s3">,</span>
  <span class="s1">key_data </span><span class="s3">as </span><span class="s1">key_data</span><span class="s3">,</span>
  <span class="s1">laplace </span><span class="s3">as </span><span class="s1">laplace</span><span class="s3">,</span>
  <span class="s1">logistic </span><span class="s3">as </span><span class="s1">logistic</span><span class="s3">,</span>
  <span class="s1">loggamma </span><span class="s3">as </span><span class="s1">loggamma</span><span class="s3">,</span>
  <span class="s1">maxwell </span><span class="s3">as </span><span class="s1">maxwell</span><span class="s3">,</span>
  <span class="s1">multivariate_normal </span><span class="s3">as </span><span class="s1">multivariate_normal</span><span class="s3">,</span>
  <span class="s1">normal </span><span class="s3">as </span><span class="s1">normal</span><span class="s3">,</span>
  <span class="s1">orthogonal </span><span class="s3">as </span><span class="s1">orthogonal</span><span class="s3">,</span>
  <span class="s1">pareto </span><span class="s3">as </span><span class="s1">pareto</span><span class="s3">,</span>
  <span class="s1">permutation </span><span class="s3">as </span><span class="s1">permutation</span><span class="s3">,</span>
  <span class="s1">poisson </span><span class="s3">as </span><span class="s1">poisson</span><span class="s3">,</span>
  <span class="s1">rademacher </span><span class="s3">as </span><span class="s1">rademacher</span><span class="s3">,</span>
  <span class="s1">randint </span><span class="s3">as </span><span class="s1">randint</span><span class="s3">,</span>
  <span class="s1">random_gamma_p </span><span class="s3">as </span><span class="s1">random_gamma_p</span><span class="s3">,</span>
  <span class="s1">rayleigh </span><span class="s3">as </span><span class="s1">rayleigh</span><span class="s3">,</span>
  <span class="s1">rbg_key </span><span class="s3">as </span><span class="s1">rbg_key</span><span class="s3">,</span>
  <span class="s1">shuffle </span><span class="s3">as </span><span class="s1">shuffle</span><span class="s3">,</span>
  <span class="s1">split </span><span class="s3">as </span><span class="s1">split</span><span class="s3">,</span>
  <span class="s1">t </span><span class="s3">as </span><span class="s1">t</span><span class="s3">,</span>
  <span class="s1">threefry_2x32 </span><span class="s3">as </span><span class="s1">threefry_2x32</span><span class="s3">,</span>
  <span class="s1">threefry2x32_key </span><span class="s3">as </span><span class="s1">threefry2x32_key</span><span class="s3">,</span>
  <span class="s1">threefry2x32_p </span><span class="s3">as </span><span class="s1">threefry2x32_p</span><span class="s3">,</span>
  <span class="s1">truncated_normal </span><span class="s3">as </span><span class="s1">truncated_normal</span><span class="s3">,</span>
  <span class="s1">uniform </span><span class="s3">as </span><span class="s1">uniform</span><span class="s3">,</span>
  <span class="s1">unsafe_rbg_key </span><span class="s3">as </span><span class="s1">unsafe_rbg_key</span><span class="s3">,</span>
  <span class="s1">wald </span><span class="s3">as </span><span class="s1">wald</span><span class="s3">,</span>
  <span class="s1">weibull_min </span><span class="s3">as </span><span class="s1">weibull_min</span><span class="s3">,</span>
<span class="s1">)</span>
</pre>
</body>
</html>